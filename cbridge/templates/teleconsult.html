{% extends 'base.html' %}

{% block title %}Video{% endblock %}
{% block head %}
<style>
    body { margin: 0; }
    #jitsi-container { height: 100vh; }
</style>
{% endblock %}
{% block content %}
    <h1>Video View</h1>
    <div class="container mt-4">
        <!-- Video Consultation Section -->
        <div class="row mb-3">
            <div class="col">
                <div id="jitsi-container" class="container mt-4"></div>
                <button id="fullscreen-toggle" class="btn btn-secondary mt-2">Toggle Fullscreen</button>
            </div>
        </div>

        <script src='{{ VIDEO_HOST_URL }}video/external_api.js'></script>


        {% if session['current_role'] == 'clinician' %}
        <!-- Tabbed Interface for Doctor -->
        <div class="row">
            <div class="col">
                <ul class="nav nav-tabs" id="consultTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="demographics-tab" data-bs-toggle="tab" href="#demographics" role="tab">Patient Demographics</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="complaints-tab" data-bs-toggle="tab" href="#complaints" role="tab">Current Complaint</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="drugs-tab" data-bs-toggle="tab" href="#drugs" role="tab">Ongoing Drugs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="lab-reports-tab" data-bs-toggle="tab" href="#lab-reports" role="tab">Lab Reports</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="management-plan-tab" data-bs-toggle="tab" href="#management-plan" role="tab">Management Plan</a>
                    </li>
                </ul>
                <div class="tab-content mt-3" id="consultTabContent">
                    <!-- Demographics Tab -->
                    <div class="tab-pane fade show active" id="demographics" role="tabpanel">
                        <iframe src="{{ url_for('emr.demographics', patient_id=conference.appointment.patient_id) }}" style="width: 100%; height: 400px;" frameborder="0"></iframe>
                    </div>
                    <!-- Complaints Tab -->
                    <div class="tab-pane fade" id="complaints" role="tabpanel">
                        <iframe src="{{ url_for('emr.complaints', patient_id=conference.appointment.patient_id) }}" style="width: 100%; height: 400px;" frameborder="0"></iframe>
                    </div>
                    <!-- Allergies Tab -->
                    <div class="tab-pane fade" id="allergies" role="tabpanel">
                        <iframe src="{{ url_for('emr.allergies', patient_id=conference.appointment.patient_id) }}" style="width: 100%; height: 400px;" frameborder="0"></iframe>
                    </div>
                    <!-- Ongoing Drugs Tab -->
                    <div class="tab-pane fade" id="drugs" role="tabpanel">
                        <iframe src="{{ url_for('emr.drugs', patient_id=conference.appointment.patient_id) }}" style="width: 100%; height: 400px;" frameborder="0"></iframe>
                    </div>
                    <!-- Lab Reports Tab -->
                    <div class="tab-pane fade" id="lab-reports" role="tabpanel">
                        <iframe src="{{ url_for('emr.lab_reports', patient_id=conference.appointment.patient_id) }}" style="width: 100%; height: 400px;" frameborder="0"></iframe>
                    </div>
                    <!-- Management Plan Tab -->
                    <div class="tab-pane fade" id="management-plan" role="tabpanel">
                        <iframe src="{{ url_for('emr.management_plan', patient_id=conference.appointment.patient_id) }}" style="width: 100%; height: 400px;" frameborder="0"></iframe>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Buttons for Doctor -->
        <div class="row mt-4">
            <div class="col text-end">
                <button id="complete-consult" class="btn btn-success">Complete Consultation</button>
            </div>
        </div>
        {% endif %}
    </div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {{ reason | default('Are you sure you want to proceed?') }}
                <div id="cooldown-timer" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" id="cancel-exit" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirm-exit" class="btn btn-primary">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
    let countdown = false;
    let countdownInterval;
    let exit_initiatedByJitsi = false;
    let lastJitsiEventTime = 0; // Timestamp of the last Jitsi event
    const DEBOUNCE_DELAY = 10000;

    function resetCooldown() {
        countdown = false;
        countdownInterval = 3;
        exit_initiatedByJitsi = false;
    }

    function startCooldown(reason, initiatedByJitsi = false) {
        exit_initiatedByJitsi = initiatedByJitsi;
        countdown = true;
        let timeLeft = 3;
        $('#cooldown-timer').text(`Redirecting in ${timeLeft} seconds...`);
        $('#confirmationModal').modal('show');

        let countdownProcess = setInterval(function() {
            timeLeft--;
            $('#cooldown-timer').text(`Redirecting in ${timeLeft} seconds...`);
            if (timeLeft <= 0) {
                clearInterval(countdownProcess);
                console.log(countdown);
                if (countdown == false && exit_initiatedByJitsi) {
                    /* Aborted, video closed */
                    resetCooldown();
                    exit_initiatedByJitsi = false;
                    window.location.reload();
                    
                    console.log('xxreload');
                } else if (countdown == true && exit_initiatedByJitsi) {
                    /* Lobby, please */
                    window.location.href='{{ lobby_url }}';
                    console.log('xxgoto lobby')
                } else if (countdown == true) {
                    /* Completion of consultation */
                    {% if session['current_role'] == 'clinician' %}
                    fetch("{{ url_for('consult.conclude_appointment', appointment_id=conference.appointment_id) }}", { method: 'GET', credentials: 'same-origin' });
                    {% endif %}
                    window.location.href='{{ lobby_url }}';
                    console.log('xxgoto lobby+complete');
                } else {
                    resetCooldown();
                    console.log('xxcountdown=false');
                }
            }
        }, 1000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const domain = '{{ VIDEO_HOST_DOMAIN }}';  // Your Jitsi domain
        const options = {
            roomName: '{{ conference.url }}',  // Conference room name
            width: '100%',
            height: '50%',
            jwt: '{{ jwt }}',
            parentNode: document.querySelector('#jitsi-container'),
            configOverwrite: { 
                startWithAudioMuted: false,
                prejoinPageEnabled: false
            },
            interfaceConfigOverwrite: { 
                filmStripOnly: false,
                
            }
        };
        const api = new JitsiMeetExternalAPI(domain, options);
        api.addListener('audioMuteStatusChanged', () => console.log('xxMute state changed'));
        api.addListener('videoConferenceFailed', () => console.log('xxConference failed'));
        api.addListener('videoConferenceJoined', () => console.log('xxConference joined'));
        api.addListener('videoConferenceLeft', conferenceLeft);
        api.addListener('videoConferenceWillJoin', () => console.log('xxConference will join'));
        api.addListener('videoConferenceWillJoin', () => console.log('xxConference will join'));


        function conferenceLeft(event) {
            now = Date.now()
            console.log('xxConference left');
           
            if (now-lastJitsiEventTime > DEBOUNCE_DELAY) {
                lastJitsiEventTime = now; // Update the last event time
                resetCooldown();
                startCooldown('Video conference ended', true);
                
            }

            console.log('xxExit::', event, now - lastJitsiEventTime);
            

        }

        // Fullscreen toggle
        $('#fullscreen-toggle').on('click', function() {
            const iframe = document.getElementById('jitsi-container');
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                iframe.requestFullscreen().catch(err => console.log(err));
            }
        });

        {% if session['current_role'] == 'clinician' %}
        // Confirmation for consultation completion
        $('#complete-consult').on('click', function() {
            $('#confirmationModal').modal('show');
            startCooldown('Consultation completed', false);
        });

        {% endif %}

        $('#confirm-exit').on('click', function() {
            // Continue the countdown and execute the redirect
            window.location.href='{{ lobby_url }}';
        });

        $('#cancel-exit').on('click', function() {
            // Cancel the countdown and reset variables
            clearInterval(countdownInterval);
            countdown = false;
            $('#confirmationModal').modal('hide');
        });

        $('#confirmationModal').on('hidden.bs.modal', function() {
            if (exit_initiatedByJitsi && countdown) {
                location.reload();
            }
        });
    });

    
    
</script>
{% endblock %}